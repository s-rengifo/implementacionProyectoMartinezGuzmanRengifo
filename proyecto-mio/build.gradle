plugins {
    id 'java'
    id 'application'
    id 'com.zeroc.gradle.ice-builder.slice' version '1.5.0'
}

group = 'com.mio.swarch'
version = '1.0-SNAPSHOT'

repositories {
    mavenCentral()
    maven { url 'https://repo.zeroc.com/nexus/content/repositories/releases' }
}

dependencies {
    // ZeroC ICE
    implementation 'com.zeroc:ice:3.7.10'

    // CSV Processing
    implementation 'com.opencsv:opencsv:5.9'

    // Logging
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'ch.qos.logback:logback-classic:1.4.11'

    // Database
    implementation 'org.postgresql:postgresql:42.7.1'
    implementation 'com.zaxxer:HikariCP:5.1.0'

    // Utilities
    implementation 'com.google.guava:guava:32.1.3-jre'
    implementation 'org.apache.commons:commons-math3:3.6.1'

    // Testing
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.1'
    testImplementation 'org.mockito:mockito-core:5.7.0'
}

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

application {
    mainClass = 'com.mio.swarch.MasterServer'
}

test {
    useJUnitPlatform()
}

slice {
    java {
        files = [file('src/main/slice/mio.ice')]
        output = file('src/main/java')
    }
}

tasks.withType(JavaExec) {
    jvmArgs = [
            '-Xms2g',
            '-Xmx4g',
            '-XX:+UseG1GC',
            '-XX:MaxGCPauseMillis=200'
    ]

    standardInput = System.in
    standardOutput = System.out
    errorOutput = System.err
}

// Master Server
task runMaster(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.MasterServer'

    jvmArgs = [
            '-Xms2g',
            '-Xmx6g',
            '-XX:+UseG1GC',
            '-XX:MaxGCPauseMillis=200',
            '-XX:+UseStringDeduplication',
            '-Xlog:gc*:file=gc-master.log:time,level,tags'
    ]
}

// Worker Node
task runWorker(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.WorkerNode'

    jvmArgs = [
            '-Xms1g',
            '-Xmx3g',
            '-XX:+UseG1GC',
            '-XX:MaxGCPauseMillis=200',
            '-XX:+UseStringDeduplication'
    ]

    if (project.hasProperty('args')) {
        args(project.property('args').toString().tokenize(' '))
    }
}

// Cliente
task runClient(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.ClientApp'

    jvmArgs = [
            '-Xms512m',
            '-Xmx1g'
    ]
}

// ========== TAREAS PARA STREAMING ==========

// Streaming Server (Broker)
task runStreamingServer(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.StreamingServer'

    jvmArgs = [
            '-Xms1g',
            '-Xmx2g',
            '-XX:+UseG1GC'
    ]
}

// Bus Simulator
task runBusSimulator(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.BusSimulatorNode'

    jvmArgs = [
            '-Xms512m',
            '-Xmx1g'
    ]

    if (project.hasProperty('args')) {
        args(project.property('args').toString().tokenize(' '))
    }
}

// Stream Subscriber
task runStreamSubscriber(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'com.mio.swarch.StreamSubscriberNode'

    jvmArgs = [
            '-Xms1g',
            '-Xmx2g',
            '-XX:+UseG1GC'
    ]

    if (project.hasProperty('args')) {
        args(project.property('args').toString().tokenize(' '))
    }
}